<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Counter Clerk Test</title>
    <script src="./CounterClerk.js"></script>
    <style>
        div.counter-clerk-render-entry {
            display: block;
            margin: 5px;
            border: 1px solid gray;
        }

        div.counter-clerk-render-entry-inline {
            display: inline-block;
            margin: 5px;
            border: 1px solid lightgray;
        }
    </style>
</head>
<body>
<h1>Counter Clerk Test</h1>
<div>
    <h2>Transactions</h2>
    <div id="history">
        <!--        <table>-->
        <!--            <tr>-->
        <!--                <th colspan="2">REQUEST</th>-->
        <!--                <th colspan="2">RESPONSE</th>-->
        <!--            </tr>-->
        <!--        </table>-->
    </div>
    <div>
        <label for="command_input"></label><input id="command_input"/>
        <button onclick="sendCommand()">Send</button>
    </div>
</div>
<script>
    let app = new CounterClerk()

    let history_div = document.getElementById("history")

    app
        .setCallApiFunction((command) => {
            return app.xhrKit().postJsonForJson("http://localhost:8000/cct", {command: command})
                .then(resp => {
                    return new Promise((resolve, reject) => {
                        if (resp.getStatusCode() !== 200) {
                            reject(new Error("status code is " + resp.getStatusCode()))
                        } else {
                            const json = resp.getResponseJson()
                            if (json.code !== 'OK') {
                                reject(new Error("FAILED: " + json.data))
                            }
                            resolve(json.data)
                        }
                    })
                })
        })
        .setShowCommandSentFunction((context) => {
            const command = context.command

            let d = document.createElement("div")

            let p1 = document.createElement("p")
            p1.innerText = new Date().toLocaleString() + " sent command"
            d.appendChild(p1)

            let p2 = document.createElement("pre")
            p2.innerText = command
            d.appendChild(p2)

            history_div.appendChild(d)

            context.box = d
        })
        .setShowCommandDoneFunction((context, resp) => {
            let d = context.box

            let p1 = document.createElement("p")
            p1.innerText = new Date().toLocaleString() + " done"
            d.appendChild(p1)

            let p2 = document.createElement("div")
            // p2.innerText = resp
            CounterClerk.renderAnything(p2, resp)
            d.appendChild(p2)
        })
        .setShowCommandErrorFunction((context, error) => {
            let d = context.box

            let p1 = document.createElement("p")
            p1.innerText = new Date().toLocaleString() + " error"
            d.appendChild(p1)

            let p2 = document.createElement("div")
            // p2.innerText = error
            CounterClerk.renderAnything(p2, error)
            d.appendChild(p2)
        })

    function sendCommand() {
        let command = document.getElementById("command_input").value
        app.sendCommand(command)
    }

</script>
</body>
</html>